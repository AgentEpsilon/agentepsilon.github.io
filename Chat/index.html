<!DOCTYPE html>
<html>
<head>
<title>Multi-User Chat</title>
<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
<script type='text/javascript' src='https://cdn.firebase.com/js/client/1.1.1/firebase.js'></script>
<script type='text/javascript' src='../marked.min.js'></script>
</head>
<body>
	<div id='ccontainer'>
<div id='chat'></div>
<div id='box'>
	<input type='text' id='message' placeholder='Message'>
</div>
<input type='button' id='logout' value='Logout'>
</div>
<div id='lcontainer'>
	<h1>Login</h1>
	<input type='text' id='email' placeholder='Email'><br />
	<input type='password' id='password' placeholder='Password'><br />
	<input type='submit' id='login'><br />
	<a href='register.html'>Create a new Account</a>
</div>
<script type='text/javascript'>
	var chat = new Firebase('https://ae-chat.firebaseio.com');
	var auth;
	if(auth=chat.getAuth()){
		$('#lcontainer').hide();
		console.log('Welcome back, '+auth.password.email);
	}else{
	$('#ccontainer').hide();
	}


	$('#login').bind('click', function(){
		chat.authWithPassword({email:$('#email').val(),password:$('#password').val()}, function(err, autharg){if(err===null){
			$('#ccontainer').show();
			$('#lcontainer').hide();
			$('#message').focus();
			auth=autharg;
		}else{alert("Could not log in: "+error);}
		});
	});

	$('#logout').bind('click', function(){
		chat.unauth();
		location.reload();
	});

	$('#message').keypress(function(e){
		if(e.keyCode == 13){
			var name = auth.password.email;
			var ren = new marked.Renderer();
			ren.paragraph = function(text){return text;};
			var message = marked($('#message').val(), {renderer:ren});
			chat.push({name: name, message: message});
			$('#message').val('');
		}
	});
	chat.on('child_added', function(data){
		var msg = data.val();
		$('#chat').append('<p>'+msg.name+':\t'+msg.message+'</p>');
	});
	chat.on('child_changed', function(data){
		location.reload();
	});
	chat.on('child_removed', function(data){
		location.reload();
	});

	
</script>
</body>
</html>
